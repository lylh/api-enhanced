<!--
 * @Author: paner 328538688@qq.com
 * @Date: 2025-09-21 10:36:27
 * @LastEditors: paner 328538688@qq.com
 * @LastEditTime: 2025-09-27 09:14:49
 * @FilePath: \api-enhanced\public\qrlogin.html
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>二维码登录</title>
</head>

<body>
  <img id="qrImg" />
  <div id="info" class="info"></div>
  <div id="loginStatus" style="display: none;">
    <h3>当前登录状态</h3>
    <div id="userInfo"></div>
    <button id="reLoginBtn" onclick="forceReLogin()">重新登录</button>
  </div>
  <script src="https://fastly.jsdelivr.net/npm/axios@0.26.1/dist/axios.min.js
    "></script>
  <script>
    async function login() {
      let timer
      let timestamp = Date.now()
      const cookie = localStorage.getItem('cookie')
      
      // 先检查登录状态
      const loginStatus = await getLoginStatus(cookie)
      
      // 如果已经登录且账号信息有效，显示登录状态和选择界面
      if (loginStatus && loginStatus.data && loginStatus.data.account && loginStatus.data.account.id) {
        showLoginStatus(loginStatus.data)
        return
      }
      
      // 显示二维码登录界面
      showQRLogin()
    }
    
    function showLoginStatus(userData) {
      document.querySelector('#qrImg').style.display = 'none'
      document.querySelector('#info').style.display = 'none'
      document.querySelector('#loginStatus').style.display = 'block'
      document.querySelector('#userInfo').innerText = `已登录用户: ${userData.profile.nickname}\nUID: ${userData.account.id}`
    }
    
    function forceReLogin() {
      // 清除本地存储的cookie
      localStorage.removeItem('cookie')
      // 显示二维码登录界面
      showQRLogin()
      // 隐藏登录状态界面
      document.querySelector('#loginStatus').style.display = 'none'
    }
    
    async function showQRLogin() {
      document.querySelector('#qrImg').style.display = 'block'
      document.querySelector('#info').style.display = 'block'
      document.querySelector('#info').innerText = '正在生成二维码...'
      
      const res = await axios({
        url: `/login/qr/key?timestamp=${Date.now()}`,
      })
      const key = res.data.data.unikey
      const res2 = await axios({
        url: `/login/qr/create?key=${key}&qrimg=true&timestamp=${Date.now()}&ua=pc`,
      })
      document.querySelector('#qrImg').src = res2.data.data.qrimg

      let expiredCount = 0
      timer = setInterval(async () => {
        const statusRes = await checkStatus(key)
        
        // 登录成功，立即处理
        if (statusRes.code === 803) {
          clearInterval(timer)
          alert('授权登录成功')
          
          // 设置浏览器cookie
          setCookieToBrowser(statusRes.cookie)
          
          // 保存到localStorage作为备份
          localStorage.setItem('cookie', statusRes.cookie)
          
          // 获取登录状态
          await getLoginStatus(statusRes.cookie, 'display')
          return
        }
        
        // 二维码过期处理 - 增加容错机制
        if (statusRes.code === 800) {
          expiredCount++
          // 连续收到2次过期状态才真正认为过期，避免网络延迟导致的误判
          if (expiredCount >= 2) {
            alert('二维码已过期,请重新获取')
            clearInterval(timer)
          }
        } else {
          // 重置过期计数器
          expiredCount = 0
        }
        
        // 等待扫码状态
        if (statusRes.code === 801) {
          document.querySelector('#info').innerText = '等待扫码...'
        }
        
        // 已扫码，等待确认
        if (statusRes.code === 802) {
          document.querySelector('#info').innerText = '已扫码，请在手机上确认登录'
        }
      }, 3000)
    }
    login()

    // 设置浏览器cookie的函数
    function setCookieToBrowser(cookieString) {
      try {
        // 解析cookie字符串
        const cookies = cookieString.split(';')
        cookies.forEach(cookie => {
          const trimmedCookie = cookie.trim()
          if (trimmedCookie) {
            // 设置cookie到浏览器，添加路径和域名
            document.cookie = `${trimmedCookie}; path=/; domain=${window.location.hostname}`
          }
        })
        console.log('[QR Login] Browser cookies set successfully')
      } catch (error) {
        console.error('[QR Login] Failed to set browser cookies:', error)
      }
    }

    async function checkStatus(key) {
      const res = await axios({
        url: `/login/qr/check?key=${key}&timestamp=${Date.now()}&ua=pc`,
      })
      return res.data
    }
    async function getLoginStatus(cookie = '') {
      try {
        const res = await axios({
          url: `/login/status?timestamp=${Date.now()}&ua=pc`,
          method: 'post',
          data: {
            cookie,
          },
        })
        
        // 如果不是在检查初始登录状态，则显示信息
        if (arguments.length > 1 && arguments[1] === 'display') {
          document.querySelector('#info').innerText = JSON.stringify(res.data, null, 2)
        }
        
        return res.data
      } catch (error) {
        console.error('获取登录状态失败:', error)
        return null
      }
    }
  </script>
  <style>
    .info {
      white-space: pre;
    }
    
    #loginStatus {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    
    #loginStatus h3 {
      margin-top: 0;
      color: #333;
    }
    
    #userInfo {
      margin: 10px 0;
      white-space: pre-line;
      color: #666;
    }
    
    #reLoginBtn {
      padding: 8px 16px;
      background-color: #1890ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    #reLoginBtn:hover {
      background-color: #40a9ff;
    }
  </style>
</body>

</html>
