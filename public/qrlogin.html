<!--
 * @Author: paner 328538688@qq.com
 * @Date: 2025-09-21 10:36:27
 * @LastEditors: paner 328538688@qq.com
 * @LastEditTime: 2025-09-27 09:14:49
 * @FilePath: \api-enhanced\public\qrlogin.html
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>二维码登录</title>
</head>

<body>
  <img id="qrImg" />
  <div id="info" class="info"></div>
  <div id="loginStatus" style="display: none;">
    <h3>当前登录状态</h3>
    <div id="userInfo"></div>
    <button id="reLoginBtn" onclick="forceReLogin()">重新登录</button>
  </div>
  <script src="https://fastly.jsdelivr.net/npm/axios@0.26.1/dist/axios.min.js
    "></script>
  <script>
    async function login() {
      let timer
      let timestamp = Date.now()
      
      // 尝试多种方式获取cookie，确保一致性
      let cookie = await getBestAvailableCookie()
      
      // 先检查登录状态
      const loginStatus = await getLoginStatus(cookie)
      
      // 如果已经登录且账号信息有效，显示登录状态和选择界面
      if (loginStatus && loginStatus.data && loginStatus.data.account && loginStatus.data.account.id && !loginStatus.data.account.anonimousUser) {
        showLoginStatus(loginStatus.data)
        return
      }
      
      // 如果cookie无效或用户是匿名用户，清理无效cookie并显示二维码登录
      if (cookie) {
        console.log('[Login] Cookie invalid or user anonymous, cleaning up...')
        localStorage.removeItem('cookie')
        // 清理浏览器cookie
        clearBrowserCookies()
      }
      
      // 显示二维码登录界面
      showQRLogin()
    }
    
    function showLoginStatus(userData) {
      document.querySelector('#qrImg').style.display = 'none'
      document.querySelector('#info').style.display = 'none'
      document.querySelector('#loginStatus').style.display = 'block'
      document.querySelector('#userInfo').innerText = `已登录用户: ${userData.profile.nickname}\nUID: ${userData.account.id}`
    }
    
    function forceReLogin() {
      // 清除本地存储的cookie
      localStorage.removeItem('cookie')
      // 显示二维码登录界面
      showQRLogin()
      // 隐藏登录状态界面
      document.querySelector('#loginStatus').style.display = 'none'
    }
    
    async function showQRLogin() {
      document.querySelector('#qrImg').style.display = 'block'
      document.querySelector('#info').style.display = 'block'
      document.querySelector('#info').innerText = '正在生成二维码...'
      
      try {
        const res = await axios({
          url: `/login/qr/key?timestamp=${Date.now()}`,
          timeout: 10000,
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        })
        const key = res.data.data.unikey
        console.log('[QR Login] Generated key:', key)
        
        const res2 = await axios({
          url: `/login/qr/create?key=${key}&qrimg=true&timestamp=${Date.now()}&ua=pc`,
          timeout: 10000,
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        })
        console.log('[QR Login] QR code created successfully')
        document.querySelector('#qrImg').src = res2.data.data.qrimg
        document.querySelector('#info').innerText = '请使用网易云音乐APP扫描二维码登录'

        let expiredCount = 0
        let checkCount = 0
        const maxChecks = 60 // 最多检查60次（3分钟）
        const maxRetries = 10 // 增加最大重试次数到10次
        
        timer = setInterval(async () => {
        checkCount++
        
        try {
          const statusRes = await checkStatus(key)
          
          // 登录成功，立即处理
          if (statusRes.code === 803) {
            clearInterval(timer)
            alert('授权登录成功')
            
            // 设置浏览器cookie
            setCookieToBrowser(statusRes.cookie)
            
            // 保存到localStorage作为备份
            localStorage.setItem('cookie', statusRes.cookie)
            
            // 获取登录状态
            const loginStatus = await getLoginStatus(statusRes.cookie, 'display')
            
            // 如果获取到登录状态，显示登录信息
            if (loginStatus && loginStatus.data) {
              showLoginStatus(loginStatus.data)
              
              // 同步保存到服务器（可选，用于多设备同步）
              try {
                await axios.post('/cookie/save', {
                  cookie: statusRes.cookie,
                  userId: loginStatus.data.account?.id
                })
                console.log('[QR Login] Cookie saved to server')
              } catch (saveError) {
                console.warn('[QR Login] Failed to save cookie to server:', saveError)
              }
            }
            
            return
          }
          
          // 处理网络错误（包括502代理服务器错误）
          if (statusRes.code === -1 || statusRes.code === -2 || statusRes.code === -3 || statusRes.code === -4) {
            expiredCount++
            console.warn('[QR Check] Network/Server error, retry count:', expiredCount, 'Error type:', statusRes.message)
            
            // 优化用户提示信息
            if (statusRes.code === -2) {
              document.querySelector('#info').innerText = `网络连接中断，正在重试... (${expiredCount}/${maxRetries})`
            } else if (statusRes.code === -4) {
              document.querySelector('#info').innerText = `网络响应较慢，正在重试... (${expiredCount}/${maxRetries})`
            } else if (statusRes.code === -3) {
              document.querySelector('#info').innerText = `服务器繁忙，正在重试... (${expiredCount}/${maxRetries})`
            } else {
              document.querySelector('#info').innerText = `网络异常，正在重试... (${expiredCount}/${maxRetries})`
            }
            
            // 增加重试次数到10次，给网络问题更多恢复时间
            if (expiredCount >= maxRetries) {
              clearInterval(timer)
              alert('网络连接持续异常，请重新获取二维码')
              setTimeout(() => {
                showQRLogin()
              }, 1000)
              return
            }
            return // 跳过本次检查，等待下次重试
          }
          
          // 二维码过期处理
          if (statusRes.code === 800) {
            clearInterval(timer)
            console.log('[QR Check] QR code expired, regenerating...')
            alert('二维码已过期,请重新获取')
            // 自动重新生成二维码
            setTimeout(() => {
              showQRLogin()
            }, 1000)
            return
          }
          
          // 等待扫码状态
          if (statusRes.code === 801) {
            document.querySelector('#info').innerText = '等待扫码...'
            expiredCount = 0 // 重置过期计数器
          }
          
          // 已扫码，等待确认
          if (statusRes.code === 802) {
            document.querySelector('#info').innerText = '已扫码，请在手机上确认登录'
            expiredCount = 0 // 重置过期计数器
          }
          
          // 检查是否超时（3分钟无响应）
          if (checkCount >= maxChecks) {
            clearInterval(timer)
            alert('二维码检查超时，请重新获取')
            setTimeout(() => {
              showQRLogin()
            }, 1000)
            return
          }
          
        } catch (error) {
           console.error('检查二维码状态时发生未预期错误:', error)
           // 对于未预期的错误，也增加错误计数
           expiredCount++
           if (expiredCount >= 3) {
             clearInterval(timer)
             alert('系统异常，请重新获取二维码')
             setTimeout(() => {
               showQRLogin()
             }, 1000)
             return
           }
         }
      }, 3000)
      
      } catch (error) {
        console.error('[QR Login] Failed to generate QR code:', error)
        document.querySelector('#info').innerText = '生成二维码失败，请刷新页面重试'
        alert('生成二维码失败，请检查网络连接后重试')
      }
    }
    login()

    // 获取最佳可用cookie的函数
    async function getBestAvailableCookie() {
      try {
        // 1. 首先尝试从浏览器cookie获取
        const browserCookie = document.cookie
        if (browserCookie && browserCookie.includes('MUSIC_U=')) {
          console.log('[Cookie] Using browser cookie')
          return browserCookie
        }
        
        // 2. 从localStorage获取
        const localStorageCookie = localStorage.getItem('cookie')
        if (localStorageCookie && localStorageCookie.includes('MUSIC_U=')) {
          console.log('[Cookie] Using localStorage cookie')
          // 同步到浏览器cookie
          setCookieToBrowser(localStorageCookie)
          return localStorageCookie
        }
        
        // 3. 尝试从服务器获取cookie列表，选择最新的
        try {
          const cookieListRes = await axios.get('/cookie/list')
          if (cookieListRes.data && cookieListRes.data.data && cookieListRes.data.data.length > 0) {
            // 按最后使用时间排序，选择最新的
            const latestCookie = cookieListRes.data.data.sort((a, b) => 
              new Date(b.lastUsed) - new Date(a.lastUsed)
            )[0]
            
            if (latestCookie && latestCookie.cookieString) {
              console.log('[Cookie] Using server cookie for user:', latestCookie.userId)
              // 保存到localStorage和浏览器
              localStorage.setItem('cookie', latestCookie.cookieString)
              setCookieToBrowser(latestCookie.cookieString)
              return latestCookie.cookieString
            }
          }
        } catch (serverError) {
          console.warn('[Cookie] Failed to fetch server cookies:', serverError)
        }
        
        console.log('[Cookie] No valid cookie found')
        return null
      } catch (error) {
        console.error('[Cookie] Error getting best available cookie:', error)
        return null
      }
    }
    
    // 清理浏览器cookie的函数
    function clearBrowserCookies() {
      try {
        const cookies = document.cookie.split(';')
        cookies.forEach(cookie => {
          const eqPos = cookie.indexOf('=')
          const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim()
          if (name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`
            console.log('[Cookie] Cleared browser cookie:', name)
          }
        })
      } catch (error) {
        console.error('[Cookie] Failed to clear browser cookies:', error)
      }
    }

    // 设置浏览器cookie的函数
    function setCookieToBrowser(cookieString) {
      try {
        console.log('[QR Login] Setting cookies:', cookieString)
        
        // 解析cookie字符串
        const cookies = cookieString.split(';')
        cookies.forEach(cookie => {
          const trimmedCookie = cookie.trim()
          if (trimmedCookie && !trimmedCookie.includes('=')) {
            // 跳过无效的cookie片段
            return
          }
          
          if (trimmedCookie) {
            // 提取cookie名称和值
            const [nameValue, ...attributes] = trimmedCookie.split(';')
            const [name, value] = nameValue.split('=')
            
            if (name && value) {
              // 设置cookie到浏览器，确保正确的格式
              let cookieStr = `${name.trim()}=${value.trim()}; path=/`
              
              // 如果是HTTPS，添加Secure标志
              if (window.location.protocol === 'https:') {
                cookieStr += '; Secure'
              }
              
              // 添加SameSite属性
              cookieStr += '; SameSite=Lax'
              
              document.cookie = cookieStr
              console.log('[QR Login] Set cookie:', cookieStr)
            }
          }
        })
        
        // 验证cookie是否设置成功
        console.log('[QR Login] Current document.cookie:', document.cookie)
        console.log('[QR Login] Browser cookies set successfully')
      } catch (error) {
        console.error('[QR Login] Failed to set browser cookies:', error)
      }
    }

    async function checkStatus(key) {
       try {
         const res = await axios({
           url: `/login/qr/check?key=${key}&timestamp=${Date.now()}&ua=pc`,
           timeout: 20000, // 增加到20秒超时，给网络更多时间
           headers: {
             'Cache-Control': 'no-cache',
             'Pragma': 'no-cache'
           }
         })
         console.log('[QR Check] Status response:', res.data)
         return res.data
       } catch (error) {
         console.error('[QR Check] Request failed:', error)
         
         // 特殊处理502 Bad Gateway错误
         if (error.response && error.response.status === 502) {
           console.warn('[QR Check] 502 Bad Gateway detected, proxy server issue')
           return { code: -2, message: 'Proxy Server Error (502)' }
         }
         
         // 处理其他HTTP错误
         if (error.response) {
           console.error('[QR Check] HTTP Error:', error.response.status, error.response.statusText)
           return { code: -3, message: `HTTP Error: ${error.response.status}` }
         }
         
         // 处理网络超时或连接错误
         if (error.code === 'ECONNABORTED' || error.message.includes('timeout')) {
           console.error('[QR Check] Request timeout')
           return { code: -4, message: 'Request Timeout' }
         }
         
         // 返回一个表示网络错误的状态
         return { code: -1, message: 'Network Error' }
       }
     }
    async function getLoginStatus(cookie, display) {
      try {
        // 如果没有提供cookie，尝试获取最佳可用cookie
        if (!cookie) {
          cookie = await getBestAvailableCookie()
          console.log('[Login Status] No cookie provided, using best available:', !!cookie)
        }
        
        if (!cookie) {
          console.log('[Login Status] No cookie available')
          return null
        }
        
        console.log('[Login Status] Checking with cookie present:', !!cookie)
        
        const response = await axios.post('/login/status', 
          { cookie: cookie },
          {
            withCredentials: true,
            headers: {
              'Content-Type': 'application/json',
              ...(cookie && { 'Cookie': cookie })
            }
          }
        )
        
        console.log('[Login Status] Response:', response.data)
        
        // 检查是否为匿名用户
        if (response.data && response.data.data && response.data.data.account) {
          const account = response.data.data.account
          if (account.anonimousUser) {
            console.log('[Login Status] Anonymous user detected, cookie may be invalid')
            return null
          }
        }
        
        if (display && response.data && response.data.data) {
          showLoginStatus(response.data.data)
        }
        
        return response.data
      } catch (error) {
        console.error('[Login Status] Error:', error)
        return null
      }
    }
  </script>
  <style>
    .info {
      white-space: pre;
    }
    
    #loginStatus {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    
    #loginStatus h3 {
      margin-top: 0;
      color: #333;
    }
    
    #userInfo {
      margin: 10px 0;
      white-space: pre-line;
      color: #666;
    }
    
    #reLoginBtn {
      padding: 8px 16px;
      background-color: #1890ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    #reLoginBtn:hover {
      background-color: #40a9ff;
    }
  </style>
</body>

</html>
